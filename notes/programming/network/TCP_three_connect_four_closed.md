# TCP 三次握手和四次挥手

## 三次握手

首先 `Client` 端发送连接请求报文，`Server` 端接收连接后回复 `ACK` 报文，并为这次连接分配资源。
`Client` 端接收到 `ACK` 报文后也向 `Server` 端发发送 `ACK` 报文，并分配资源，这样 `TCP` 连接就建立了。

1. 客户端的 `TCP` 先向服务器的 `TCP` 发送一个连接请求报文。这个特殊的报文中不含应用层数据，其首部中的 `SYN` 标志位被置 `1`。另外， 客户端会随机选择一个起始序号 `seq=x`(连接请求报文不携带数据，但要消耗掉一个序号)。
2. 服务器端的 `TCP` 收到连接请求报文后，若同意建立连接，就向客户端发送请求，并为该 `TCP` 连接分配 `TCP` 缓存和变量。在确认报文中，`SYN` 和 `ACK` 位都被置为 `1`， 确认好字段的值为 `x+1`，并且服务器随机产生起始序号 `seq=y`(确认报文不携带数据， 但也要消耗掉一个序号)。确认报文同样不包含应用层数据。
3. 当客户端收到确认报文后，还要向服务器给出确认，并且也要给该连接分配缓存和变量。这个报文的 `ACK` 标志位被置为 `1`，序号字段为 `x+1`，确认号字段为 `y+1`。

## 四次挥手

1. 客户端打算关闭连接，就向其 `TCP` 发送一个连接释放报文，并停止再发送数据，主动关闭 `TCP` 连接，该报文的 `FIN` 标志位被置 `1`，`seq=u`，它等于前面已经传送过的数据的最后一个字节的序号加 `1`(`FIN` 报文即使不携带数据，也要消耗掉一个序号)。
2. 服务器接收连接释放报文后即发出确认，确认号是 `ack=u+1`，这个报文自己的序号是 `v`，等于它前面已传送过的数据的最后一个自己的序号加 `1`。此时，从客户端到服务器这个方向的连接就释放了，`TCP` 连接处于半关闭状态。但服务器若发送数据，客户端仍要接收，即从服务器到客户机的连接仍未关闭。
3. 若服务器已经没有了要向客户端发送的数据，就通知 `TCP` 释放连接，此时其发出 `FIN=1` 的连接释放报文。
4. 客户端收到连接释放报文后，必须发出确认。在确认报文中，`ACK` 字段被置为 `1`，确认号 `ack=w+1`，序号 `seq=u+1`。此时，`TCP` 连接还没有释放掉，必须经过等待计时器设置的时间 `2MSL` 后，`A` 才进入到连接关闭状态。

## 参考资料

- [TCP 三次握手和四次挥手-网络知识面面观](https://segmentfault.com/a/1190000016921268#articleHeader1)
- [通俗大白话来理解 TCP 协议的三次握手和四次分手](https://github.com/jawil/blog/issues/14)
